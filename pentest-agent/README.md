# Pentest Agent (Autónomo Simulado con DQN)

> ⚠️ **CLÁUSULA LEGAL OBLIGATORIA**: No ejecutar contra sistemas, redes o servicios sin **permiso por escrito** del propietario/autorizado. Debe existir alcance (`scope`) documentado antes de cualquier prueba.

Este repositorio implementa un agente autónomo de pentesting **simulado** con Deep Q-Learning (DQN, PyTorch), backend FastAPI, dashboard Streamlit y persistencia SQLite.

## Seguridad por diseño
- No incluye exploits reales.
- `backend/exploit_stub.py` solo simula resultados.
- Toda acción de tipo `exploitation` requiere aprobación humana (`allow/deny`) antes de ejecutarse.
- Para crear targets, se exige `AUTH_TOKEN` válido y opcionalmente `scope.txt` existente.

## Arquitectura
- `backend/`: API, orquestación, entorno simulado, persistencia.
- `rl/`: red DQN, replay buffer, entrenamiento, checkpoints.
- `dashboard/`: interfaz de control humano.
- `installer/`: scripts base de instalador (Inno Setup/NSIS).

## Estado → Vector
En `backend/environment.py`, la función `state_to_vector()` convierte resultados del entorno a:
`[open_port, service_detected, attempts, previous_success, vuln_score]`.

## Reward
Escala en `environment.apply_exploit_result()`:
- éxito explotación: `+1.0`
- fallo explotación: `-0.6`
- denegación humana: `-0.2`
- acciones pasivas: costo/recompensa pequeña (`-0.05` a `+0.1`)

## Checkpoints y persistencia de entrenamiento
Se guarda con `torch.save()` un dict con:
- `model_state_dict`
- `optimizer_state_dict`
- `epsilon`
- `episode`

Formato recomendado para reanudar entrenamiento (state_dict + optimizer).

## API mínima
- `POST /targets`
- `GET /targets/{id}`
- `POST /report_vuln`
- `POST /request_authorization`
- `GET /pending_authorizations`
- `POST /decide`
- `GET /metrics`

Todas exigen API key (`x-api-key`, `PENTEST_AGENT_API_KEY`).

## Ejecutar local
```bash
pip install -r requirements.txt
export PYTHONPATH=$(pwd)
export PENTEST_AGENT_API_KEY=dev-internal-key
export AUTH_TOKEN=I_HAVE_WRITTEN_PERMISSION
uvicorn backend.app:app --reload
# otra terminal
python -m backend.agent_runner
# otra terminal
streamlit run dashboard/app.py
```

Usa VM o contenedor aislado para pruebas.

## Distribución desktop (PyInstaller)
El launcher de escritorio (`desktop_launcher.py`) arranca **embebido** en el mismo proceso:
1. backend FastAPI con `uvicorn.Server(...)` (sin invocar `uvicorn` por CLI externa),
2. espera a `/health`,
3. dashboard Streamlit con `streamlit.web.bootstrap.run(...)` (sin `streamlit run` externo),
4. espera a `/_stcore/health`,
5. abre una sola pestaña del navegador.

### Build del `.exe`
Ejecuta desde la raíz del proyecto (`pentest-agent/`):
```bash
pyinstaller --clean --noconfirm build.spec
```

### Dónde queda el ejecutable
- Binario final: `dist/PentestAgent.exe`
- Carpeta temporal de build: `build/`

### Persistencia fuera del `.exe`
Los datos se guardan fuera del ejecutable para no perder estado entre ejecuciones:
- Base SQLite: `%APPDATA%/PentestAgent/agent.db`
- Modelo RL: `%APPDATA%/PentestAgent/model_latest.pt`
- Fallback no-Windows: `~/.pentest_agent/PentestAgent/`

### Instalador opcional
- Inno Setup: `installer/inno_setup.iss`
- NSIS: `installer/nsis_installer.nsi`

## Referencias
- PyTorch DQN Tutorial: https://pytorch.org/tutorials/intermediate/reinforcement_q_learning.html
- PyTorch Saving/Loading Models: https://pytorch.org/tutorials/beginner/saving_loading_models.html
- NIST SP 800-115 (Technical Guide to Information Security Testing and Assessment) — autorización y alcance documentado.
- PTES (Penetration Testing Execution Standard): http://www.pentest-standard.org/
