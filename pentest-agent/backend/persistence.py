from __future__ import annotations

import os
import sqlite3
from dataclasses import dataclass
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Optional


def get_data_dir() -> Path:
    appdata = os.getenv("APPDATA")
    if appdata:
        base = Path(appdata)
    else:
        base = Path.home() / ".pentest_agent"
    path = base / "PentestAgent"
    path.mkdir(parents=True, exist_ok=True)
    return path


def get_db_path() -> Path:
    return get_data_dir() / "agent.db"


@dataclass
class Persistence:
    db_path: Path = get_db_path()

    def __post_init__(self) -> None:
        self._init_schema()

    def _connect(self) -> sqlite3.Connection:
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        return conn

    def _init_schema(self) -> None:
        with self._connect() as conn:
            conn.executescript(
                """
                CREATE TABLE IF NOT EXISTS targets (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    ip TEXT NOT NULL,
                    status TEXT NOT NULL DEFAULT 'created',
                    auth_token TEXT,
                    scope_path TEXT,
                    created_at TEXT NOT NULL
                );
                CREATE TABLE IF NOT EXISTS vulnerabilities (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    target_id INTEGER,
                    vuln_id TEXT,
                    severity TEXT,
                    description TEXT,
                    suggested_action TEXT,
                    q_value REAL,
                    created_at TEXT NOT NULL
                );
                CREATE TABLE IF NOT EXISTS actions (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    target_id INTEGER,
                    action TEXT,
                    action_type TEXT,
                    result TEXT,
                    reward REAL,
                    created_at TEXT NOT NULL
                );
                CREATE TABLE IF NOT EXISTS authorizations (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    target_id INTEGER,
                    ip TEXT,
                    vuln_id TEXT,
                    action TEXT,
                    q_values TEXT,
                    timestamp TEXT,
                    decision TEXT DEFAULT 'pending',
                    user TEXT,
                    comment TEXT,
                    decided_at TEXT
                );
                CREATE TABLE IF NOT EXISTS training_checkpoints (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    episode INTEGER,
                    epsilon REAL,
                    model_path TEXT,
                    avg_reward REAL,
                    created_at TEXT NOT NULL
                );
                """
            )

    def create_target(self, ip: str, auth_token: str, scope_path: Optional[str]) -> int:
        now = datetime.utcnow().isoformat()
        with self._connect() as conn:
            cur = conn.execute(
                "INSERT INTO targets (ip, auth_token, scope_path, created_at) VALUES (?, ?, ?, ?)",
                (ip, auth_token, scope_path, now),
            )
            return int(cur.lastrowid)

    def get_target(self, target_id: int) -> Optional[Dict[str, Any]]:
        with self._connect() as conn:
            row = conn.execute("SELECT * FROM targets WHERE id = ?", (target_id,)).fetchone()
            return dict(row) if row else None

    def add_vulnerability(self, payload: Dict[str, Any]) -> None:
        with self._connect() as conn:
            conn.execute(
                """INSERT INTO vulnerabilities
                (target_id, vuln_id, severity, description, suggested_action, q_value, created_at)
                VALUES (?, ?, ?, ?, ?, ?, ?)""",
                (
                    payload.get("target_id"),
                    payload.get("vuln_id"),
                    payload.get("severity"),
                    payload.get("description"),
                    payload.get("suggested_action"),
                    payload.get("q_value", 0.0),
                    datetime.utcnow().isoformat(),
                ),
            )

    def log_action(self, target_id: int, action: str, action_type: str, result: str, reward: float) -> None:
        with self._connect() as conn:
            conn.execute(
                "INSERT INTO actions (target_id, action, action_type, result, reward, created_at) VALUES (?, ?, ?, ?, ?, ?)",
                (target_id, action, action_type, result, reward, datetime.utcnow().isoformat()),
            )

    def create_authorization(self, payload: Dict[str, Any]) -> int:
        with self._connect() as conn:
            cur = conn.execute(
                """INSERT INTO authorizations
                (target_id, ip, vuln_id, action, q_values, timestamp)
                VALUES (?, ?, ?, ?, ?, ?)""",
                (
                    payload.get("target_id"),
                    payload.get("ip"),
                    payload.get("vuln_id"),
                    payload.get("action"),
                    str(payload.get("q_values", [])),
                    payload.get("timestamp", datetime.utcnow().isoformat()),
                ),
            )
            return int(cur.lastrowid)

    def pending_authorizations(self) -> List[Dict[str, Any]]:
        with self._connect() as conn:
            rows = conn.execute("SELECT * FROM authorizations WHERE decision = 'pending' ORDER BY id DESC").fetchall()
            return [dict(r) for r in rows]

    def decide_authorization(self, auth_id: int, decision: str, user: str, comment: str) -> None:
        with self._connect() as conn:
            conn.execute(
                "UPDATE authorizations SET decision = ?, user = ?, comment = ?, decided_at = ? WHERE id = ?",
                (decision, user, comment, datetime.utcnow().isoformat(), auth_id),
            )

    def add_checkpoint(self, episode: int, epsilon: float, model_path: str, avg_reward: float) -> None:
        with self._connect() as conn:
            conn.execute(
                "INSERT INTO training_checkpoints (episode, epsilon, model_path, avg_reward, created_at) VALUES (?, ?, ?, ?, ?)",
                (episode, epsilon, model_path, avg_reward, datetime.utcnow().isoformat()),
            )

    def latest_checkpoint(self) -> Optional[Dict[str, Any]]:
        with self._connect() as conn:
            row = conn.execute("SELECT * FROM training_checkpoints ORDER BY id DESC LIMIT 1").fetchone()
            return dict(row) if row else None

    def metrics(self) -> Dict[str, Any]:
        with self._connect() as conn:
            checkpoints = conn.execute("SELECT COUNT(*) as c FROM training_checkpoints").fetchone()["c"]
            rewards = conn.execute("SELECT AVG(reward) as avg_reward FROM actions").fetchone()["avg_reward"]
            actions = conn.execute("SELECT COUNT(*) as c FROM actions").fetchone()["c"]
            return {
                "checkpoints": checkpoints,
                "avg_reward": rewards if rewards is not None else 0.0,
                "actions_logged": actions,
                "latest_checkpoint": self.latest_checkpoint(),
            }
