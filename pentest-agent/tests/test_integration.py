from __future__ import annotations

import os
import tempfile
from pathlib import Path

from fastapi.testclient import TestClient

os.environ["PENTEST_AGENT_API_KEY"] = "test-key"
os.environ["AUTH_TOKEN"] = "ALLOW"
os.environ["APPDATA"] = tempfile.mkdtemp()

from backend.app import app
from backend.persistence import Persistence


def headers():
    return {"x-api-key": "test-key"}


def test_api_and_persistence_flow():
    client = TestClient(app)
    r = client.post("/targets", headers=headers(), json={"ip": "10.0.0.1", "auth_token": "ALLOW", "scope_path": None})
    assert r.status_code == 200
    tid = r.json()["target_id"]

    rv = client.post("/report_vuln", headers=headers(), json={
        "target_id": tid,
        "vuln_id": "SIM-1",
        "severity": "low",
        "description": "desc",
        "suggested_action": "attempt_exploit_stub_x",
        "q_value": 0.2,
    })
    assert rv.status_code == 200

    ra = client.post("/request_authorization", headers=headers(), json={
        "target_id": tid,
        "ip": "10.0.0.1",
        "vuln_id": "SIM-1",
        "action": "attempt_exploit_stub_x",
        "q_values": [0.1, 0.2],
        "timestamp": "2024-01-01T00:00:00",
    })
    auth_id = ra.json()["auth_id"]
    p = client.get("/pending_authorizations", headers=headers())
    assert any(i["id"] == auth_id for i in p.json()["items"])

    d = client.post("/decide", headers=headers(), json={"auth_id": auth_id, "decision": "allow", "user": "tester", "comment": "ok"})
    assert d.status_code == 200

    db = Persistence()
    assert db.metrics()["actions_logged"] >= 0


def test_checkpoint_roundtrip(tmp_path: Path):
    import pytest

    torch = pytest.importorskip("torch")
    from rl.checkpoints import load_checkpoint, save_checkpoint
    from rl.neural_policy import DQN

    model = DQN(5, 4)
    opt = torch.optim.Adam(model.parameters(), lr=1e-3)
    path = tmp_path / "model.pt"
    save_checkpoint(path, model, opt, epsilon=0.5, episode=3)
    ckpt = load_checkpoint(path, model, opt)
    assert ckpt["episode"] == 3
    assert abs(ckpt["epsilon"] - 0.5) < 1e-8
