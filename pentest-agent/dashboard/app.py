from __future__ import annotations

import os

import requests
import streamlit as st

from dashboard.ui_helpers import severity_color, vuln_table

BACKEND = os.getenv("BACKEND_URL", "http://127.0.0.1:8000")
API_KEY = os.getenv("PENTEST_AGENT_API_KEY", "dev-internal-key")
HEADERS = {"x-api-key": API_KEY}

st.set_page_config(page_title="Pentest Agent Dashboard", layout="wide")
st.title("Pentest Agent (Simulado) — Control Humano")

ip = st.text_input("Target IP", "127.0.0.1")
auth_token = st.text_input("AUTH_TOKEN", type="password")
scope_path = st.text_input("Ruta scope.txt (opcional)", "")
if st.button("Start scan"):
    res = requests.post(
        f"{BACKEND}/targets",
        json={"ip": ip, "auth_token": auth_token, "scope_path": scope_path or None},
        headers=HEADERS,
        timeout=10,
    )
    st.write(res.json())

col1, col2 = st.columns([2, 1])
with col1:
    st.subheader("Autorizaciones pendientes")
    pending = requests.get(f"{BACKEND}/pending_authorizations", headers=HEADERS, timeout=10).json()["items"]
    for item in pending:
        st.markdown(f"**{item['ip']}** → `{item['action']}` | vuln `{item['vuln_id']}`")
        c1, c2 = st.columns(2)
        if c1.button(f"Allow #{item['id']}"):
            requests.post(f"{BACKEND}/decide", json={"auth_id": item["id"], "decision": "allow", "user": "dashboard", "comment": "approved"}, headers=HEADERS, timeout=10)
        if c2.button(f"Deny #{item['id']}"):
            requests.post(f"{BACKEND}/decide", json={"auth_id": item["id"], "decision": "deny", "user": "dashboard", "comment": "denied"}, headers=HEADERS, timeout=10)

    st.subheader("Vulnerabilidades (simuladas)")
    rows = []
    table = vuln_table(rows)
    st.dataframe(table)

with col2:
    st.subheader("Métricas")
    metrics = requests.get(f"{BACKEND}/metrics", headers=HEADERS, timeout=10).json()
    st.json(metrics)
    st.caption("Logs/decisiones se consultan vía polling al backend.")

st.info("Los intentos de explotación son solo stubs y requieren autorización explícita.")
